<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet author="denis-kartavenko" id="addColumn-currency-to-expense-table">
        <addColumn tableName="expense">
            <column name="currency" type="varchar(3)">
                <constraints nullable="true" foreignKeyName="expense_currency_fk" references="currency(code)"/>
            </column>
        </addColumn>

        <sql>
            UPDATE expense SET currency = sub.rc FROM (
	            SELECT ex.currency exc, r.currency rc, r.token FROM expense ex
	            JOIN room r on ex.room_token = r.token) as sub
            WHERE expense.room_token = sub.token
        </sql>
    </changeSet>
</databaseChangeLog>